{% load staticfiles %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    {#    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css"/>#}
    <style type="text/css">
        body, html, #container {
            width: 100%;
            height: 100%;
            margin: 0;
            font: 12px Arial;
        }

        .custom-input-card .btn:last-child {
            margin-left: 1rem;
        }

        .content-window-card p {
            height: 2rem;
        }

        .input-card {
            display: flex;
            flex-direction: column;
            min-width: 0;
            word-wrap: break-word;
            background-color: #fff;
            background-clip: border-box;
            width: 160px;
            height: 62px;
            border-width: 0;
            border-radius: 0.4rem;
            box-shadow: 0 2px 6px 0 rgba(114, 124, 245, .5);
            bottom: 1rem;
            right: 1rem;
            -ms-flex: 1 1 auto;
            flex: 1 1 auto;
        / / line-height: 50 px;
        }
    </style>
    <link rel="icon" type="image/png" href="{% static 'images/favicon.ico' %}">
    <title>地图显示</title>
</head>
<body>
<div id="container"></div>
<script src="https://webapi.amap.com/maps?v=1.4.15&key=5cda232d2d1f782a634096167304eb59"></script>
<script src="{% static 'vendor/jquery/jquery.min.js' %}"></script>
<script type="text/javascript">

    var devices_data = {{ devices_data|safe }};
    //console.log(devices_data);
    var provinces = [];
    var s_data = {};
    $.each(devices_data, function (i, value) {
        s_data = {};
        s_data['imei'] = value.imei;
        s_data['device_id'] = value.device_id;
        s_data['desc'] = value.desc;
        s_data['time'] = value.time;
        s_data['speed'] = value.speed;
        s_data['longitude'] = value.longitude;
        s_data['latitude'] = value.latitude;
        s_data['type'] = value.type;
        //console.log(s_data);
        provinces.push(s_data);
    });
    //console.log(provinces);
    var map = new AMap.Map('container', {resizeEnable: true, zoom: 4});
    var markers = []; //province见Demo引用的JS文件
    var host = location.host;
    //console.log(host);
    var infoWindow = new AMap.InfoWindow({offset: new AMap.Pixel(0, -30)});
    for (var i = 0; i < provinces.length; i += 1) {
        var marker;
        var device_id = provinces[i].device_id;
        //var title = "设备名称：" + provinces[i].desc + "，" + "设备序列号：" + provinces[i].imei + "<br><br>" + "速度：" + provinces[i].speed + "，" + "时间：" + provinces[i].time;
        var title = "&nbsp;" + provinces[i].desc + "<br>" + "&nbsp;" + provinces[i].imei + "<br>" + "&nbsp;" + provinces[i].speed + " m/s <br>&nbsp;" + provinces[i].time;
        var src = '/dataInfo/locationInfo/' + device_id + '/';
        var icon;
        if (provinces[i].type === 1) {
            icon = new AMap.Icon({
                image: 'http://' + host + '/media/image/green_point.png',
                size: new AMap.Size(32, 32),
            });
            marker = new AMap.Marker({
                icon: icon,
                position: [provinces[i].longitude, provinces[i].latitude],
                offset: new AMap.Pixel(-12, -12),
                zIndex: 101,
                title: provinces[i].name,
                map: map
            });

        } else {
            title = "&nbsp;" + provinces[i].desc + "<br>" + "&nbsp;" + provinces[i].imei + "<br>" + "&nbsp;" + provinces[i].speed + "<br>&nbsp;" + provinces[i].time;
            icon = new AMap.Icon({
                image: 'http://' + host + '/media/image/red_point.png',
                size: new AMap.Size(32, 32)
            });
            marker = new AMap.Marker({
                icon: icon,
                position: [provinces[i].longitude, provinces[i].latitude],
                offset: new AMap.Pixel(-12, -12),
                zIndex: 101,
                title: provinces[i].name,
                map: map
            });

        }
        //var content = "<div class='input-card content-window-card'><a onclick=\"javascript:top.location.href='" + src + "'\">" + title + "</a></div>";
        var content = "<div ><a onclick=\"javascript:top.location.href='" + src + "'\">" + title + "</a></div>";
        //guzhang = new AMap.Marker({
        //    content: content,
        //    position: [provinces[i].longitude, provinces[i].latitude],
        //    title: provinces[i].name,
        //    offset: new AMap.Pixel(-70, -75),   // 设置测站点名字与图片相对位置
        //    map: map
        //});
        markers.push(marker);
        //markers.push(guzhang);
        marker.content = content;
        marker.on('click', markerClick);
        marker.emit('click', {target: marker});
    }

    function markerClick(e) {
        infoWindow.setContent(e.target.content);
        infoWindow.open(map, e.target.getPosition());
    }

    map.setFitView();
</script>
<script>
    var url = window.location.pathname;

    function shuaxin() {
        $.ajax({
            method: 'POST',
            url: url,
            success: function (data) {
                //console.log(data.devices_data);
                provinces = [];
                $.each(data.devices_data, function (i, value) {
                    s_data = {};
                    s_data['imei'] = value.imei;
                    s_data['device_id'] = value.device_id;
                    s_data['desc'] = value.desc;
                    s_data['time'] = value.time;
                    s_data['speed'] = value.speed;
                    s_data['longitude'] = value.longitude;
                    s_data['latitude'] = value.latitude;
                    s_data['type'] = value.type;
                    //console.log(s_data);
                    provinces.push(s_data);
                });
                for (var i = 0; i < provinces.length; i += 1) {
                    device_id = provinces[i].device_id;
                    // TODO 更新链接跳转到设备信息查询
                    //console.log(device_id);
                    src = '/dataInfo/locationInfo/' + device_id + '/';
                    content = "<div class='input-card content-window-card'><a onclick=\"javascript:top.location.href='" + src + "'\">" + title + "</a></div>";
                    if (provinces[i].type === 1) {
                        title = "&nbsp;" + provinces[i].desc + "<br>" + "&nbsp;" + provinces[i].imei + "<br>" + "&nbsp;" + provinces[i].speed + " m/s <br>&nbsp;" + provinces[i].time;
                        icon = new AMap.Icon({
                            image: 'http://' + host + '/media/image/green_point.png',
                            size: new AMap.Size(32, 32),
                        });
                        marker = new AMap.Marker({
                            icon: icon,
                            position: [provinces[i].longitude, provinces[i].latitude],
                            offset: new AMap.Pixel(-12, -12),
                            zIndex: 101,
                            title: provinces[i].name,
                            map: map
                        });

                    } else {
                        title = "&nbsp;" + provinces[i].desc + "<br>" + "&nbsp;" + provinces[i].imei + "<br>" + "&nbsp;" + provinces[i].speed + "<br>&nbsp;" + provinces[i].time;
                        icon = new AMap.Icon({
                            image: 'http://' + host + '/media/image/red_point.png',
                            size: new AMap.Size(32, 32)
                        });
                        marker = new AMap.Marker({
                            icon: icon,
                            position: [provinces[i].longitude, provinces[i].latitude],
                            offset: new AMap.Pixel(-12, -12),
                            zIndex: 101,
                            title: provinces[i].name,
                            map: map
                        });

                    }
                    //content = "<div class='input-card content-window-card'><a onclick=\"javascript:top.location.href='" + src + "'\">" + title + "</a></div>";
                    content = "<div ><a onclick=\"javascript:top.location.href='" + src + "'\">" + title + "</a></div>";
                    //guzhang = new AMap.Marker({
                    //    content: content,
                    //    position: [provinces[i].longitude, provinces[i].latitude],
                    //    title: provinces[i].name,
                    //    offset: new AMap.Pixel(-70, -75),   // 设置测站点名字与图片相对位置
                    //    map: map
                    //});
                    markers.push(marker);
                    //markers.push(guzhang);
                    marker.content = content;
                    marker.on('click', markerClick);
                    //marker.emit('click', {target: marker});
                }

            }
        })
    }

    // 清楚定位点和信息框
    function removeMarkers() {
        map.remove(markers);
    }

    /*每30秒刷新一次*/
    setInterval(function () {
            removeMarkers();
            shuaxin();
        },
        30000);
</script>
</body>
</html>